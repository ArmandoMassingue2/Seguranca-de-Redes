<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Certificados - SecureMessaging</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .crypto-card {
            transition: transform 0.2s;
        }
        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/chat">
                <i class="fas fa-lock"></i> SecureMessaging
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/chat">
                    <i class="fas fa-comments"></i> Chat
                </a>
                <a class="nav-link active" href="/certificates">
                    <i class="fas fa-certificate"></i> Certificados
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4"><i class="fas fa-certificate"></i> Gestão de Certificados Digitais</h2>

        <!-- Status da CA -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-shield-alt"></i> Status da Autoridade Certificadora (CA)</h5>
                        <div id="caStatus">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Verificando status...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações Principais -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card crypto-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-key fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Gerar Chaves</h5>
                        <p class="card-text">Gere um novo par de chaves RSA 2048-bit</p>
                        <button class="btn btn-primary" id="generateKeysBtn">
                            <i class="fas fa-plus"></i> Gerar Chaves
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card crypto-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-certificate fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Certificado Auto-Assinado</h5>
                        <p class="card-text">Crie um certificado auto-assinado</p>
                        <button class="btn btn-success" id="generateSelfSignedBtn">
                            <i class="fas fa-file-signature"></i> Gerar Certificado
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card crypto-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-stamp fa-3x text-warning mb-3"></i>
                        <h5 class="card-title">Certificado Assinado CA</h5>
                        <p class="card-text">Gere um certificado assinado pela CA</p>
                        <button class="btn btn-warning" id="generateCASignedBtn">
                            <i class="fas fa-award"></i> Gerar Certificado CA
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status de Criptografia -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-shield-alt"></i> Status de Criptografia
                        </h5>
                        <div id="cryptoInfo">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Carregando informações...
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-info" id="testEncryptionBtn">
                                <i class="fas fa-vial"></i> Testar Criptografia
                            </button>
                        </div>
                        <div id="encryptionResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progresso e Mensagens -->
        <div id="certificateProgress"></div>
        <div id="certificateResult"></div>

        <!-- Formulário de Certificado (Oculto por padrão) -->
        <div class="row mb-4" id="certificateForm" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Dados do Certificado</h5>
                        <form id="certDataForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="certCommonName" class="form-label">Nome Comum (CN)</label>
                                    <input type="text" class="form-control" id="certCommonName" 
                                           th:value="${#authentication.name}" placeholder="Seu nome">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="certEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="certEmail" 
                                           placeholder="email@exemplo.com">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="certOrganization" class="form-label">Organização (O)</label>
                                    <input type="text" class="form-control" id="certOrganization" 
                                           value="SecureMessaging">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="certOU" class="form-label">Unidade (OU)</label>
                                    <input type="text" class="form-control" id="certOU" 
                                           value="Users">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="certLocality" class="form-label">Localidade</label>
                                    <input type="text" class="form-control" id="certLocality" 
                                           value="Maputo">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="certState" class="form-label">Estado</label>
                                    <input type="text" class="form-control" id="certState" 
                                           value="Maputo">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="certCountry" class="form-label">País</label>
                                    <input type="text" class="form-control" id="certCountry" 
                                           value="MZ" maxlength="2">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="certValidity" class="form-label">Validade (anos)</label>
                                    <input type="number" class="form-control" id="certValidity" 
                                           value="1" min="1" max="10">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="certKeySize" class="form-label">Tamanho da Chave</label>
                                    <select class="form-select" id="certKeySize">
                                        <option value="2048" selected>2048 bits (Recomendado)</option>
                                        <option value="4096">4096 bits (Máxima Segurança)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary" id="cancelCertBtn">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="submitCertBtn">
                                    <i class="fas fa-check"></i> Gerar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Certificados -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-list"></i> Meus Certificados</h5>
                        <div id="certificatesList">
                            <div class="text-center text-muted">
                                <i class="fas fa-certificate fa-3x mb-3"></i>
                                <p>Você ainda não possui certificados. Gere um acima!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/crypto-manager.js"></script>
    <script src="/js/certificate-generator.js"></script>
    
    <script>
        // Configuração inicial
        $(document).ready(function() {
            // Define usuário atual
            window.currentUser = '[[${#authentication.name}]]';
            
            // Carrega status da CA
            loadCAStatus();
            
            // Carrega informações de criptografia
            loadCryptoInfo();
            
            // Eventos dos botões
            $('#generateKeysBtn').click(generateKeys);
            $('#generateSelfSignedBtn').click(() => showCertForm('self-signed'));
            $('#generateCASignedBtn').click(() => showCertForm('ca-signed'));
            $('#cancelCertBtn').click(() => $('#certificateForm').hide());
            $('#testEncryptionBtn').click(testEncryption);
            
            // Submit do formulário
            $('#certDataForm').submit(function(e) {
                e.preventDefault();
                const certType = $(this).data('cert-type');
                if (certType === 'self-signed') {
                    window.certGenerator.generateSelfSigned();
                } else {
                    window.certGenerator.generateCASigned();
                }
            });
        });

        function loadCAStatus() {
            $.get('/pki/api/ca/certificate')
                .done(function(response) {
                    if (response.success) {
                        showCAStatus(true, response.certificate);
                    } else {
                        showCAStatus(false);
                    }
                })
                .fail(function() {
                    showCAStatus(false);
                });
        }

        function showCAStatus(exists, cert) {
            let html;
            if (exists) {
                html = `
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle"></i> Certificado CA está ativo e válido
                                <br><small>Válido até: ${new Date(cert.validTo).toLocaleDateString('pt-BR')}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="viewCACert()">
                                <i class="fas fa-eye"></i> Visualizar
                            </button>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-exclamation-triangle"></i> Nenhum Certificado CA encontrado
                            </div>
                            <button class="btn btn-sm btn-primary" id="generateCACertBtn">
                                <i class="fas fa-plus"></i> Gerar CA
                            </button>
                        </div>
                    </div>
                `;
            }
            $('#caStatus').html(html);
            
            // Bind do botão de gerar CA
            $('#generateCACertBtn').click(function() {
                window.certGenerator.generateCACertificate();
            });
        }

        function loadCryptoInfo() {
            const algorithms = {
                RSA: { keySize: 1024, description: 'RSA 1024-bit para assinatura e troca de chaves' },
                AES: { keySize: 256, description: 'AES 256-bit para criptografia simétrica' },
                DH: { keySize: 1024, description: 'Diffie-Hellman 1024-bit para acordo de chaves' },
                SHA256: { description: 'SHA-256 para verificação de integridade' },
                SHA3: { description: 'SHA3-256/512 para hash avançado' }
            };
            
            let html = '<h6>Algoritmos Criptográficos Ativos:</h6><ul class="list-unstyled">';
            
            for (const [alg, info] of Object.entries(algorithms)) {
                html += `<li><i class="fas fa-check text-success"></i> <strong>${alg}</strong>`;
                if (info.keySize) html += ` (${info.keySize}-bit)`;
                html += `<br><small class="text-muted">${info.description}</small></li>`;
            }
            
            html += '</ul>';
            $('#cryptoInfo').html(html);
        }

        function generateKeys() {
            if (!confirm('Gerar novas chaves substituirá as chaves atuais. Continuar?')) {
                return;
            }
            
            showProgress('Gerando chaves RSA 2048-bit...', 0);
            
            $.ajax({
                url: '/api/keys/generate',
                method: 'POST',
                data: { keySize: 2048 },
                success: function(response) {
                    if (response.success) {
                        showProgress('Chaves geradas com sucesso!', 100);
                        showSuccess('Chaves RSA geradas e armazenadas com segurança!');
                    } else {
                        showError('Erro: ' + response.error);
                    }
                },
                error: function(xhr) {
                    showError('Erro ao gerar chaves: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                }
            });
        }

        function testEncryption() {
            showProgress('Testando algoritmos de criptografia...', 0);
            
            $.ajax({
                url: '/api/keys/test-encryption',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showProgress('Testes concluídos!', 100);
                        showEncryptionResults(response);
                    } else {
                        showError('Erro nos testes: ' + response.error);
                    }
                },
                error: function(xhr) {
                    showError('Erro ao testar: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                }
            });
        }

        function showEncryptionResults(results) {
            let html = '<div class="alert alert-success"><h6><i class="fas fa-check-circle"></i> Resultados dos Testes</h6><ul class="mb-0">';
            
            if (results.RSA) html += `<li>RSA: ${results.RSA.status}</li>`;
            if (results.AES) html += `<li>AES: ${results.AES.status}</li>`;
            if (results.SHA256) html += `<li>SHA-256: ${results.SHA256.status}</li>`;
            if (results.SHA3) html += `<li>SHA3: ${results.SHA3.status}</li>`;
            
            html += '</ul></div>';
            $('#encryptionResult').html(html);
        }

        function showCertForm(type) {
            $('#certificateForm').show();
            $('#certDataForm').data('cert-type', type);
            $('html, body').animate({
                scrollTop: $('#certificateForm').offset().top - 100
            }, 500);
        }

        function showProgress(message, percentage) {
            const html = `
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: ${percentage}%"></div>
                </div>
                <small class="text-muted">${message}</small>
            `;
            $('#certificateProgress').html(html);
            
            if (percentage === 100) {
                setTimeout(() => $('#certificateProgress').empty(), 3000);
            }
        }

        function showSuccess(message) {
            const html = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#certificateResult').html(html);
        }

        function showError(message) {
            const html = `
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#certificateProgress').html(html);
        }
    </script>
</body>
</html>